from pig_util import outputSchema
import re

c_reg = re.compile(r'^(.+)-(.*)\[(.+)[-|+](\d+)\] "([A-Z]+)?(.+) HTTP/\d.\d" (\d+)(\s[\d]+)?(\s"(.+)" )?(.*)$')

def analyzer(url, regex):
	compiled = re.compile(regex)
	if compiled.search(url):
		return True
	return False

def scalper(logLine, regexLine, descLine):
	if c_reg.match(logLine):
		out = c_reg.search(logLine)
		ip = out.group(1)
		name  = out.group(2)
		date = out.group(3)
		ext  = out.group(4)
		method = out.group(5)
		url = out.group(6)
		response = out.group(7)
		byte = out.group(8)
		referrer = out.group(9)
		agent = out.group(10)

		if len(url) > 1 and method in ('GET','POST','HEAD','PUT','PUSH','OPTIONS'):
			if analyzer(url, regexLine):
				return True
		return False

@outputSchema("res:chararray")
def match(logBag, regexLine, descLine):
	result=""
	for logTuple in logBag:
		for i in range(0, len(logTuple)):
			tokens = logTuple[i].split('!', 1)
			if scalper(tokens[1], regexLine, descLine):
				result += tokens[0] + "\t" + tokens[1] + "\t" + regexLine + "\t" + descLine + "\n"
	return result
