<%@ page import="requiredjava.NewPigRunner, requiredjava.DBConnection, requiredjava.SendEmail, java.sql.*" %>
<%
	if(session.getAttribute("userId") == null){
		response.sendRedirect("../");
	}
%>
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
<!-- Required JS & css
	============================================= -->
<jsp:include page="includeHeaders.jsp"></jsp:include>
<style type="text/css">
	.report-form-els{
		height: 34px;
		margin-left: 5px;
	}
	select.report-form-els{
		background: white;
		border-radius: 1px;
	}
</style>
<!-- Document Title
    ============================================= -->
<title>REPORTS | VAS</title>
</head>
<body class="stretched">
	<script type="text/javascript">
		$(document).ready(
			function(){
				$("#home-menu-button").removeClass('current');
				$("#home-menu-button a").attr('href', '../');
				$("#signout-menu-button").addClass('current');
			}
		);
	</script>
	<script src="../js/ChartJS/dist/Chart.bundle.min.js"></script>
	<!-- Document Wrapper
    ============================================= -->
	<div id="wrapper" class="clearfix">
		<!-- Page Title
        ============================================= -->
		<jsp:include page="../header.jsp"></jsp:include>
		<!-- ======================================== -->

		<nav class="navbar navbar-default">
			<div class="container">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<a class="navbar-brand">REPORTS</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse"
					id="bs-example-navbar-collapse-1">
						<ul class="nav navbar-nav navbar-right">
						<li><select id='month' style="margin-top: 10px;" class="report-form-els">
								<option selected value="0">Select Month</option>
								<option value='1'>January</option>
								<option value='2'>February</option>
								<option value='3'>March</option>
								<option value='4'>April</option>
								<option value='5'>May</option>
								<option value='6'>June</option>
								<option value='7'>July</option>
								<option value='8'>August</option>
								<option value='9'>September</option>
								<option value='10'>October</option>
								<option value='11'>November</option>
								<option value='12'>December</option>
						</select></li>
						<li><select id='year' style="margin-top: 10px;" class="report-form-els">
								<option selected value="0">Select Year</option>
								<option value='2012'>2012</option>
								<option value='2013'>2013</option>
								<option value='2014'>2014</option>
								<option value='2015'>2015</option>
								<option value='2016'>2016</option>
						</select></li>
						<li class="active">
							<button id="report-generation-button" style="margin-top: 10px;" class="button button-small">Show
								Results</button>
						</li>
					</ul>
				</div>
				<!-- /.navbar-collapse -->
			</div>
			<!-- /.container-fluid -->
		</nav>
		<!-- Content
        ============================================= -->

		<!-- Content
        ============================================= -->
        <a href="#" id="notification_bar" style='display: none;' class="btn btn-danger" data-notify-type="error" data-notify-msg="<i class=icon-remove-sign></i> Incorrect Input. Please Try Again!" onclick="SEMICOLON.widget.notifications(this); return false;"></a>
		<section id="content">
			<div class="content-wrap" style="padding-top: 0px; padding-bottom: 0px;">
				<div id="datatable" class="container clearfix topmargin">
						<TABLE BORDER="1" class="table table-hover table-bordered table-responsive ">
							<TR>
								<TH>Sr No.</TH>
								<TH>IP Address</TH>
								<TH>Count</TH>
								<TH>Type</TH>
								<TH>Link</TH>
							</TR>
							<%
								if (request.getParameter("query").equals("currentPeriod")) {
									
									NewPigRunner.analyze();
									DBConnection.Init();
									ResultSet resultset = DBConnection.executeQuery("select * from attack_report_temp ");
									
									String result="<table><tr><th>Sr No.</th><th>IP Address</th><th>Count</th><th>Type</th></tr>", temp="";
									
									while (resultset.next()) {
										temp+="<tr>";
										temp+="<td>" + resultset.getString(1) + "</td>";
										temp+="<td>" + resultset.getString(2) + "</td>";
										temp+="<td>" + resultset.getString(3) + "</td>";
										temp+="<td>" + resultset.getString(4) + "</td>";
										
										result+=temp;
										out.print(temp);
										out.print("<td><a class='fileLink' href='javascript:void(0);' title='" + resultset.getString(5) + "'>Click Here</a></td>");
										out.print("</tr>");
										
										result+="</tr>";
										temp="";
									}
									DBConnection.destroy();
									result += "</table>";
									
									DBConnection.Init();
									SendEmail.sendReport(DBConnection.getUserEmailId("admin"), result);
									DBConnection.destroy();
							%>
							<script>
								$('.fileLink').click(function(){
									window.open('getContentsOfAttackFile.jsp?path='+$(this).attr('title').trim(),'_blank');
								});
							</script>
							<%	}
							%>
						</TABLE>
				</div>
				<div class="divider divider-center"><a href="#" data-scrollto="#datatable"><i class="icon-chevron-up"></i></a></div>
				<script type="text/javascript">
					var notificationAlertBox = $("#notification_bar");
					$("#report-generation-button")
							.click(
									function() {
										var month = $(
												"select#month option:selected")
												.val();
										var year = $(
												"select#year option:selected")
												.val();

										var dataString;

										if (month == '0' && year == '0') {
											dataString = "query=overall";
										} else if (month == '0' && year != '0') {
											dataString = "query=yearly&year="
													+ year;
										} else if (month != '0' && year != '0') {
											dataString = "query=MonthYear&month="
													+ month + "&year=" + year;
										} else {
											notificationAlertBox
													.attr("data-notify-type",
															"error");
											notificationAlertBox
													.attr("data-notify-msg",
															"<i class=icon-remove-sign></i>Please fill all the fields");
											SEMICOLON.widget
													.notifications(notificationAlertBox);
											return false;
										}

										Pace
												.track(function() {
													$
															.ajax({
																type : "POST",
																url : "ReportGenerationScripts/getDetailedTable.jsp",
																data : dataString,
																cache : false,
																success : function(
																		result) {
																	$(
																			"#datatable")
																			.html(
																					"");
																	$(
																			"#datatable")
																			.html(
																					result
																							.trim());
																}
															})
												});

										return false;
									});
				</script>
			</div>
		</section>
		<!-- #content end -->
		<!-- Footer
        ============================================= -->
		<jsp:include page="../footer.jsp"></jsp:include>
		<!-- #footer end -->

	</div>
	<!-- #wrapper end -->

	<!-- Go To Top
    ============================================= -->
	<div id="gotoTop" class="icon-angle-up"></div>

	<!-- Footer Scripts
    ============================================= -->
	<script type="text/javascript" src="../js/functions.js"></script>

</body>
</html>