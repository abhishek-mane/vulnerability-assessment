<%
	if(session.getAttribute("userId") == null){
		response.sendRedirect("../");
	}
%>
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
<!-- Required JS & css
	============================================= -->
<jsp:include page="includeHeaders.jsp"></jsp:include>
<style type="text/css">
	.report-form-els{
		height: 34px;
		margin-left: 5px;
	}
	select.report-form-els{
		background: white;
		border-radius: 1px;
	}
</style>
<!-- Document Title
    ============================================= -->
<title>REPORTS | VAS</title>
</head>
<body class="stretched">
	<script type="text/javascript">
		$(document).ready(
			function(){
				$("#home-menu-button").removeClass('current');
				$("#home-menu-button a").attr('href', '../');
				$("#signout-menu-button").addClass('current');
			}
		);
	</script>
	<script src="../js/ChartJS/dist/Chart.bundle.min.js"></script>
	<!-- Document Wrapper
    ============================================= -->
	<div id="wrapper" class="clearfix">
		<!-- Page Title
        ============================================= -->
		<jsp:include page="../header.jsp"></jsp:include>
		<!-- ======================================== -->

		<nav class="navbar navbar-default">
			<div class="container">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<a class="navbar-brand">REPORTS</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse"
					id="bs-example-navbar-collapse-1">
						<ul class="nav navbar-nav navbar-right">
						<li><select id='month' style="margin-top: 10px;" class="report-form-els">
								<option selected value="0">Select Month</option>
								<option value='1'>January</option>
								<option value='2'>February</option>
								<option value='3'>March</option>
								<option value='4'>April</option>
								<option value='5'>May</option>
								<option value='6'>June</option>
								<option value='7'>July</option>
								<option value='8'>August</option>
								<option value='9'>September</option>
								<option value='10'>October</option>
								<option value='11'>November</option>
								<option value='12'>December</option>
						</select></li>
						<li><select id='year' style="margin-top: 10px;" class="report-form-els">
								<option selected value="0">Select Year</option>
								<option value='2012'>2012</option>
								<option value='2013'>2013</option>
								<option value='2014'>2014</option>
								<option value='2015'>2015</option>
								<option value='2016'>2016</option>
						</select></li>
						<li class="active">
							<button id="report-generation-button" style="margin-top: 10px;" class="button button-small">Show
								Results</button>
						</li>
					</ul>
				</div>
				<!-- /.navbar-collapse -->
			</div>
			<!-- /.container-fluid -->
		</nav>
		<!-- Content
        ============================================= -->

		<!-- Content
        ============================================= -->
        <a href="#" id="notification_bar" style='display: none;' class="btn btn-danger" data-notify-type="error" data-notify-msg="<i class=icon-remove-sign></i> Incorrect Input. Please Try Again!" onclick="SEMICOLON.widget.notifications(this); return false;"></a>
		<section id="content">
			<div class="content-wrap" style="padding-top: 0px;">
				<div class="container clearfix topmargin">
						<div class="col_half bottommargin-sm center">
								<canvas id="barChart"></canvas>
						</div>
						<div class="col_half bottommargin-sm col_last">
								<canvas id="doughnutChart"></canvas>
						</div>
						<script type="text/javascript">
							
							var notificationAlertBox = $("#notification_bar");
							// UTILITIES
							var MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
							var randomColorFactor = function() {
								return Math.round(Math.random() * 255);
							};
							var randomColor = function() {
								return 'rgba(' + randomColorFactor() + ',' + randomColorFactor() + ',' + randomColorFactor() + ',0.8)';
							};
							/***********************************/
							var dataForBarChart = {
								labels : [],
								datasets : []
							};
							var dataForDoughnutChart = {
								labels : [],
								datasets : [ {
									data : [],
									backgroundColor : [],
									hoverBackgroundColor : []
								} ]
							};
						
							
							var ctxForBarChart = document.getElementById("barChart");
							var ctxForDoughnut = document.getElementById("doughnutChart");
							window.BarChart = new Chart(ctxForBarChart, {
								type : 'bar',
								data : dataForBarChart,
							});
							
							window.DoughnutChart = new Chart(ctxForDoughnut, {
								type : 'doughnut',
								data : dataForDoughnutChart
							});
							
							
							$("#report-generation-button").click(
									function(){
										var month = $("select#month option:selected").val();
										var year = $("select#year option:selected").val();
										
										// data
										var data =new Object();
										
										if(month == '0' && year == '0'){
											$.ajax({
												type: "POST",
												url: "ReportGenerationScripts/getOverallData.jsp",
												data: "query=overall",
												cache: false,
												success: function(result){
														var splittedData = result.trim().split("&&");
														var years = splittedData[0];
														var types = splittedData[1];
														var counts = splittedData[2];
														var typesTokens = types.split(":");
														var yearsTokens = years.split(":");
														var countsTokens = counts.split(":");
														
														// Building Doughnut chart
														dataForDoughnutChart.labels = [];
														dataForBarChart.labels = [];
														for(var i=0; i<yearsTokens.length-1; ++i){
															dataForDoughnutChart.labels.push(yearsTokens[i]);
															dataForBarChart.labels.push(yearsTokens[i]);
														}
														
														var k=0;
														dataForDoughnutChart.datasets[0].data = [];
														dataForDoughnutChart.datasets[0].backgroundColor = [];
														dataForDoughnutChart.datasets[0].hoverBackgroundColor = [];
														while(true){
															var temp = 0;
															for(var i=0; i<typesTokens.length-1; ++i)
																temp += parseInt(countsTokens[k++]);
															dataForDoughnutChart.datasets[0].data.push(temp);
															var color = randomColor();
															dataForDoughnutChart.datasets[0].backgroundColor.push(color);
															dataForDoughnutChart.datasets[0].hoverBackgroundColor.push(color);
															if(k<countsTokens.length-1) continue;
															else break;
														}
														window.DoughnutChart.update();
														
														// Building Bar chart
														dataForBarChart.datasets = [];
														var len = typesTokens.length-1;
														for(var i=0; i<len; ++i){
															var temp=[];
															for(var j=0; j<yearsTokens.length-1; ++j)
																temp.push(countsTokens[len*j+i]);
															
															var color = randomColor();
															dataForBarChart.datasets.push({
																label : typesTokens[i],
																backgroundColor : color,
																borderColor : color,
																borderWidth : 1,
																hoverBackgroundColor : color,
																hoverBorderColor : color,
																data : temp
															});
														}
														
														window.BarChart.update();
												}
											});
										}
										else if(month=='0' && year!='0'){
											$.ajax({
												type: "POST",
												url: "ReportGenerationScripts/getYearlyData.jsp",
												data: "query=year&year="+year,
												cache: false,
												success: function(result){
														var splittedData = result.trim().split("&&");
														var months = splittedData[0];
														var types = splittedData[1];
														var counts = splittedData[2];
														var typesTokens = types.split(":");
														var monthsTokens = months.split(":");
														var countsTokens = counts.split(":");
														
														// Building Doughnut chart
														dataForDoughnutChart.labels = [];
														dataForBarChart.labels = [];
														for(var i=0; i<monthsTokens.length-1; ++i)
															dataForBarChart.labels.push(monthsTokens[i]);
														
														for(var i=0; i<typesTokens.length-1; ++i){
															dataForDoughnutChart.labels.push(typesTokens[i]);
														}
														
														var k=0;
														dataForDoughnutChart.datasets[0].data = [];
														dataForDoughnutChart.datasets[0].backgroundColor = [];
														dataForDoughnutChart.datasets[0].hoverBackgroundColor = [];
														
														var len = typesTokens.length-1;
														for(var i=0; i<len; ++i){
															var temp=0;
															for(var j=0; j<monthsTokens.length-1; ++j)
																temp += parseInt(countsTokens[len*j+i]);
															dataForDoughnutChart.datasets[0].data.push(temp);
															var color = randomColor();
															dataForDoughnutChart.datasets[0].backgroundColor.push(color);
															dataForDoughnutChart.datasets[0].hoverBackgroundColor.push(color);
														}
														
														// Building Bar chart
														dataForBarChart.datasets = [];
														var len = typesTokens.length-1;
														for(var i=0; i<len; ++i){
															var temp=[];
															for(var j=0; j<monthsTokens.length-1; ++j)
																temp.push(countsTokens[len*j+i]);
															
															var color = randomColor();
															dataForBarChart.datasets.push({
																label : typesTokens[i],
																backgroundColor : color,
																borderColor : color,
																borderWidth : 1,
																hoverBackgroundColor : color,
																hoverBorderColor : color,
																data : temp
															});
														}
														
														window.BarChart.update();
														window.DoughnutChart.update();
												}
											});
										}
										else if(month!='0' && year!='0'){
											$.ajax({
												type: "POST",
												url: "ReportGenerationScripts/getMonthlyData.jsp",
												data: "query=MonthYear&&month="+month+"&year="+year,
												cache: false,
												success: function(result){
														var splittedData = result.trim().split("&&");
														var types = splittedData[0];
														var counts = splittedData[1];
														var typesTokens = types.split(":");
														var countsTokens = counts.split(":");
														
														dataForBarChart.datasets = [];
														var color = randomColor();
														dataForBarChart.datasets.push({
															label : MONTHS[month-1]+" "+year,
															backgroundColor : color,
															borderColor : color,
															borderWidth : 1,
															hoverBackgroundColor : color,
															hoverBorderColor : color,
															data : []
														});
														
														// Building Doughnut chart
														dataForDoughnutChart.labels = [];
														dataForBarChart.labels = [];
														for(var i=0; i<typesTokens.length-1; ++i){
															dataForDoughnutChart.labels.push(typesTokens[i]);
															dataForBarChart.labels.push(typesTokens[i]);
														}
														
														var k=0;
														dataForDoughnutChart.datasets[0].data = [];
														dataForDoughnutChart.datasets[0].backgroundColor = [];
														dataForDoughnutChart.datasets[0].hoverBackgroundColor = [];
														
														var len = typesTokens.length-1;
														for(var i=0; i<len; ++i){
															var temp = parseInt(countsTokens[i]);
															dataForDoughnutChart.datasets[0].data.push(temp);
															dataForBarChart.datasets[0].data.push(temp);
															color = randomColor();
															dataForDoughnutChart.datasets[0].backgroundColor.push(color);
															dataForDoughnutChart.datasets[0].hoverBackgroundColor.push(color);
														}
														
														// Building Bar chart
														
														
														window.BarChart.update();
														window.DoughnutChart.update();
												}
											});
										}
										else{
											notificationAlertBox.attr("data-notify-type", "error");
											notificationAlertBox.attr("data-notify-msg", "<i class=icon-remove-sign></i>Please fill all the fields");
											SEMICOLON.widget.notifications(notificationAlertBox);
											return false;
										}
										
										
										return false;
									}
							);
						</script>
				</div>
			</div>
		</section>
		<!-- #content end -->
		<!-- Footer
        ============================================= -->
		<jsp:include page="../footer.jsp"></jsp:include>
		<!-- #footer end -->

	</div>
	<!-- #wrapper end -->

	<!-- Go To Top
    ============================================= -->
	<div id="gotoTop" class="icon-angle-up"></div>

	<!-- Footer Scripts
    ============================================= -->
	<script type="text/javascript" src="../js/functions.js"></script>

</body>
</html>