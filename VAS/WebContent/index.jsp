<%
	if(session.getAttribute("userId") != null)
		response.sendRedirect("admin/home.jsp");
%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>

	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="author" content="SemiColonWeb" />

	<!-- Stylesheets
	============================================= -->
	<link href="fonts/fonts.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="css/bootstrap.css" type="text/css" />
	<link rel="stylesheet" href="style.css" type="text/css" />
	<link rel="stylesheet" href="css/dark.css" type="text/css" />
	<link rel="stylesheet" href="css/font-icons.css" type="text/css" />
	<link rel="stylesheet" href="css/animate.css" type="text/css" />
	<link rel="stylesheet" href="css/magnific-popup.css" type="text/css" />

	<link rel="stylesheet" href="css/responsive.css" type="text/css" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
	<!--[if lt IE 9]>
		<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
	<![endif]-->

	<!-- External JavaScripts
	============================================= -->
	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/plugins.js"></script>
	
	<script data-pace-options='{ "ajax": true }' src="css/loader/pace.min.js"></script>
	<link href="css/loader/pace.css" rel="stylesheet" />

	<!-- Document Title
	============================================= -->
	<title>Login | Monitoring System</title>

</head>

<body class="stretched">
	<!-- Document Wrapper
	============================================= -->
	<div id="wrapper" class="clearfix">
		<!-- Page Title
		============================================= -->
		<jsp:include page="header.jsp"></jsp:include>
		<!-- #page-title end -->

		<!-- Content
		============================================= -->
		<section id="content">
			<div class="content-wrap" style="padding-top: 0; padding-bottom: 0;">
				<div class="container clearfix">
					<div class="tabs divcenter nobottommargin clearfix" id="tab-login-register" style="max-width: 400px;">
						<ul class="tab-nav tab-nav2 center clearfix" style="margin-top: 10px;">
							<li class="inline-block"><a href="#tab-login">Login</a></li>
							<li class="inline-block"><a href="#tab-register">Reset password</a></li>
						</ul>
						<div class="tab-container" style="padding-top:20px; padding-bottom:15px;">
							<div class="tab-content clearfix" id="tab-login">
								<div class="panel panel-default nobottommargin">
									<div class="panel-body" style="padding:40px;">
										<form id="login_form">
											<h3>Login to your Account</h3>
											<div class="col_full">
												<label>Username:</label>
												<input data-trigger="focus" data-container="body" data-toggle="popover" data-placement="right" data-content="Enter your username." type="text" id="login_username" class="form-control" />
											</div>
											<div class="col_full">
												<label>Password:</label>
												<input data-trigger="focus" data-container="body" data-toggle="popover" data-placement="right" data-content="Enter your password" type="password" id="login_password" class="form-control" />
											</div>
											<div class="col_full nobottommargin">
												<button class="button button-border button-rounded nomargin" >Login</button>
											</div>
											<a style="display: none;" href="#" id="notification_bar" class="btn btn-default" data-notify-position="top-right" data-notify-type="error" data-notify-msg="">Top Full Width</a>
										</form>
										<script>
											$("#login_form").submit(
												function(){
													var username = $('#login_username').val();
													var password = $('#login_password').val();
													
													if (username.trim()=="" || password.trim()=="")
													{
														notificationAlertBox.attr("data-notify-type", "error");
														notificationAlertBox.attr("data-notify-msg", "<i class=icon-warning-sign></i>Please fill all the fields correctly !");
														SEMICOLON.widget.notifications(notificationAlertBox);
														return false;
													}
													var postPageLink = "LoginChecker.jsp";
													var dataString = 'uname='+username+'&passwd='+password;
													$.ajax({
														type: "POST",
														url: postPageLink,
														data: dataString,
														cache: false,
														success: function(result){
															if(result.trim()=="true"){
																window.location='admin/home.jsp';
															}else{
																notificationAlertBox.attr("data-notify-type", "error");
																notificationAlertBox.attr("data-notify-msg", "<i class=icon-remove-sign></i>Log in unsuccessfull. Please try again !");
																SEMICOLON.widget.notifications(notificationAlertBox);
																return false;
															}
														}
													});
													return false;
												}
											);
										</script>
									</div>
								</div>
								<div class="style-msg nobottommargin" style="background-color: #EEE; margin-top:20px;">
									<div class="sb-msg"><strong>Note:</strong> If you don't remember your password you can reset it using reset password option.</div>
								</div>
							</div>
							<div class="tab-content clearfix" id="tab-register">
								<div class="panel panel-default nobottommargin">
									<div class="panel-body" style="padding: 40px;">
										<form id="reset_form" class="hideIt">
											<h3>Reset password</h3>
											<div class="col_full hideIt">
												<label>Username:</label>
												<input data-trigger="focus" data-container="body" data-toggle="popover" data-placement="right" data-content="Enter your username." type="text" id="reset_form_username" class="form-control" placeholder="Enter your username"/>
											</div>
											<div class="col_full">
												<label>New Password:</label>
												<input data-trigger="focus" data-container="body" data-toggle="popover" data-placement="right" data-content="Enter new password." type="password" id="reset_form_password" class="form-control" placeholder="Enter new password"/>
											</div>
											<div class="col_full">
												<label>Confirm Password:</label>
												<input data-trigger="focus" data-container="body" data-toggle="popover" data-placement="right" data-content="Confirm entered password." type="password" id="reset_form_password_confirm" class="form-control" placeholder="Confirm entered password"/>
											</div>
											<div class="col_full nobottommargin">
												<button class="button button-border button-rounded nomargin" id="reset_button">RESET</button>
											</div>
										</form>
										<form id="validate_form" class="showIt" style="display: none;">
											<div class="col_full">
												<label>Enter Code:</label>
												<input type="text" id="validate_form_code_confirm" class="form-control" placeholder="Confirm validation code"/>
											</div>
											<div class="col_full nobottommargin showIt" style="display: none;">
												<button class="button button-border button-rounded nomargin" id="validate_button">Validate</button>
											</div>
										</form>
										<script>
											var code;
											var emailId;
											var newPasswd;
											var notificationAlertBox = $("#notification_bar");
											
											$("#reset_form").submit(
												function(){
													var username = $('#reset_form_username').val();
													var password = $('#reset_form_password').val();
													var confirmedPassword = $('#reset_form_password_confirm').val();
													
													if (username.trim()=="" || password.trim()=="" || confirmedPassword.trim()==""){
														notificationAlertBox.attr("data-notify-type", "error");
														notificationAlertBox.attr("data-notify-msg", "<i class=icon-warning-sign></i>Please fill all the fields correctly !");
														SEMICOLON.widget.notifications(notificationAlertBox);
														return false;
													}
													if(password != confirmedPassword){
														notificationAlertBox.attr("data-notify-type", "error");
														notificationAlertBox.attr("data-notify-msg", "<i class=icon-warning-sign></i>Password doesn't match !");
														SEMICOLON.widget.notifications(notificationAlertBox);
														return false;
													}
													
													var postPageLink = "checkUser.jsp";
													var dataString = 'uname='+username;
													$.ajax({
														type: "POST",
														url: postPageLink,
														data: dataString,
														cache: false,
														success: function(result){
															var res = result.trim();
															if(res=="unknownUserError"){
																notificationAlertBox.attr("data-notify-type", "error");
																notificationAlertBox.attr("data-notify-msg", "<i class=icon-remove-sign></i>Unknown user !");
																SEMICOLON.widget.notifications(notificationAlertBox);
															}
															else{
																emailId = res;
																newPasswd = confirmedPassword;
																code = getRandomCode();
																$("#reset_button").text("Sending...");
																$.ajax({
																	type: "POST",
																	url: "sendMail.jsp",
																	data: 'code='+code+'&mailId='+emailId,
																	cache: false,
																	success: function(mailStatus){
																		if(mailStatus.trim() == "success"){
																			$(".hideIt").hide();
																			$(".showIt").show();
																			notificationAlertBox.attr("data-notify-type", "success");
																			notificationAlertBox.attr("data-notify-msg", "<i class=icon-ok-sign></i>Email successfully sent.");
																			SEMICOLON.widget.notifications(notificationAlertBox);
																			$("#reset_button").text("RESET");
																		}
																		else{
																			notificationAlertBox.attr("data-notify-type", "error");
																			notificationAlertBox.attr("data-notify-msg", "<i class=icon-remove-sign></i>Error Sending mail. Please try again later.");
																			SEMICOLON.widget.notifications(notificationAlertBox);
																			$("#reset_button").text("RESET");
																		}
																	}
																});
															}
														}
													});
													return false;
												}
											);
											
											function getRandomCode()
											{
												var text = "";
												var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
												for( var i=0; i < 5; i++ )
													text += possible.charAt(Math.floor(Math.random() * possible.length));

												return text;
											}
											
											$('#validate_form').submit(
												function(){
													var enteredCode = $("#validate_form_code_confirm").val().trim();
													if(enteredCode == ""){
														notificationAlertBox.attr("data-notify-type", "error");
														notificationAlertBox.attr("data-notify-msg", "<i class=icon-warning-sign></i>Please fill all the fields correctly !");
														SEMICOLON.widget.notifications(notificationAlertBox);
														return false;
													}
													
													if(enteredCode == code){
														$("#validate_button").text("Updating...");
														$.ajax({
															type: "POST",
															url: "updatePasswd.jsp",
															data: 'emailId='+emailId+'&newPasswd='+newPasswd,
															cache: false,
															success: function(status){
																if(status.trim() == "success"){
																	notificationAlertBox.attr("data-notify-type", "success");
																	notificationAlertBox.attr("data-notify-msg", "<i class=icon-ok-sign></i>Email successfully sent.");
																	SEMICOLON.widget.notifications(notificationAlertBox);
																	window.location='./';
																}
																else{
																	notificationAlertBox.attr("data-notify-type", "error");
																	notificationAlertBox.attr("data-notify-msg", "<i class=icon-remove-sign></i>Error changing password. Try again later.");
																	SEMICOLON.widget.notifications(notificationAlertBox);
																	window.location='./';
																}
															}
														});
													}else{
														notificationAlertBox.attr("data-notify-type", "error");
														notificationAlertBox.attr("data-notify-msg", "<i class=icon-warning-sign></i>Invalid code...");
														SEMICOLON.widget.notifications(notificationAlertBox);
													}
													return false;
												}
											);
										</script>
									</div>
								</div>
								<div class="style-msg alertmsg nobottommargin" style="margin-top:10px;">
									<div class="sb-msg"><i class="icon-warning-sign"></i><strong> Warning: </strong>Email will be sent on your registered email id for the confirmation.</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section><!-- #content end -->
		
		<!-- Footer
		============================================= -->
		<jsp:include page="footer.jsp"></jsp:include>
		<!-- #footer end -->

	</div><!-- #wrapper end -->

	<!-- Go To Top
	============================================= -->
	<div id="gotoTop" class="icon-angle-up"></div>

	<!-- Footer Scripts
	============================================= -->
	<script type="text/javascript" src="js/functions.js"></script>
	<script type="text/javascript">$('[data-toggle=popover]').popover();</script>
	<!--modified by us   ---->
	
 </html>